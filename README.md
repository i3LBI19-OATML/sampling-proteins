# Sampling Proteins

Consists of 2 parts:
1. Protein Generation 
2. Evaluation Framework

## Protein Generation

Generation Steps:
1. Score possible mutated/extended sequence using Tranception
2. Generate mutations key
3. Sample mutations/extension
4. Mutate/extend original sequence with key
5. Repeat (1-4) until desired parameters
*Mutate for MLDE and extend for AR

<!-- ### Single-Mutant Usage (MLDE)
```
python generator.py \
    --sequence [mdh_esm, mdh_esm_2, avGFP] \
    --model [small, medium, large] \
    --sampling_method [mirostat, top_k, top_p, typical, random, greedy] \
    --sampling_threshold (k for top-k, p for top-p, etc.) \
    --sequence_num (number of sequence to generate) \
    --evolution_cycles (number of mutation cycle) \
    --save_df (optional, save metadata of generated sequences in dataframe) \
    --output_name folder_within_generated_sequence/sub_folder/fasta_file_name
```

### Multi-Mutant Usage (MLDE)
```
python generator.py \
    --sequence [mdh_esm, mdh_esm_2, avGFP] \
    --model [small, medium, large] \
    --mutations (number of multi-mutations) \
    --use_quantfun (use QFF for intermediate strategy, else using HPF) \
    --saved_model_dir [required if using QFF, path to saved model] \
    --intermediate_threshold (threshold for intermediate strategy) \
    --sampling_method [mirostat, top_k, top_p, typical, random, greedy] \
    --sampling_threshold (k for top-k, p for top-p, etc.) \
    --sequence_num (number of sequence to generate) \
    --evolution_cycles (number of mutation cycle) \
    --save_df (optional, save metadata of generated sequences in dataframe) \
    --output_name folder_within_generated_sequence/sub_folder/fasta_file_name
```

### AR Usage
```
python AR_generator.py \
    --sequence [initial AA residue prompt] \
    --model [small, medium, large] \
    --sampling_method [mirostat, top_k, top_p, typical, random, greedy] \
    --sequence_num (number of sequence to generate) \
    --seq_length (length of sequence to generate) \
    --save_df (optional, save metadata of generated sequences in dataframe) \
    --extension_factor (number of AA residues to extend at each cycle, defaults to 1) \
    --output_name folder_within_generated_sequence/sub_folder/fasta_file_name
```

If using QFF, fine-tune the model first using the following command:
```
srun python Tranception-Protein-Generator/finetune_proteinbert.py \
    --train_data [path to training data] \
    --valid_data [path to validation/testing data] \
    --save_name [folder path for saving model] \
```
Train/Validation data needs to have 2 columns: 'seq' and 'label'. 'label' is the quantitative function value. -->

## Protein Evaluation

Calculation for various sequence- and structure-based quality scores for proteins, such as those produced by generative models.

1. Structue metrics
2. Single-sequence metrics
3. Alignment-based metrics

<!-- ### Directories
**PDBs**(pdbs & reference_pdbs): Single Chain A with scores in b-factor field (Generated by AlphaFold2)

**Target Sequences**(target_seqs): For both single-sequence and alignment-based metrics

**Reference Sequences**(reference_seqs): For alignment-based metrics
***

### Example usage
1. Scoring with single-sequence and alignment-based metrics only
```
python  protein_scoring.py \
        --output_name [directory (inside this folder) to store the output csv] \
        --target_dir [directory of target sequences in FASTA format] \
        --reference_dir [directory of reference sequences in FASTA format]
```

2. Scoring with all metrics (including structure-based metrics)
```
python  Tranception-Evaluation/protein_scoring.py \
        --score_structure [flag to include structure-based metrics] \
        --output_name [directory (inside this folder) to store the output csv] \
        --target_dir [directory of target sequences in FASTA format] \
        --reference_dir [directory of reference sequences in FASTA format] \
        --pdb_dir [directory of target sequences in pdb format] \
        --ref_pdb_dir [directory of reference sequences in pdb format]
```

3. If using **Tranception** or **EVmutation**: Add the orig_seq flag to input the original sequence. For EVmutation, run plmc and define the model params path.
```
python  protein_scoring.py \
        --output_name [directory (inside this folder) to store the output csv] \
        --target_dir [directory of target sequences in FASTA format] \
        --reference_dir [directory of reference sequences in FASTA format] \
        --use_tranception [flag to use Tranception] \ 
        --use_evmutation [flag to use EVmutation] \
        --orig_seq [string of original sequence] \
        --model_params [path to model params for EVmutation]
```-->

## Preparing EVmutation
```bash
EVmutation/plmc/bin/plmc -o [model output name].model_params \ 
                         -c [model output name].txt \
                         -f [name of target sequence (WT) from MSA file, before forwardslash (/)] \
                         -le [0.2*(N-1), N is length of target sequence] \
                         -lh 0.01 \
                         -m 200 \
                         -t 0.2 \
                         -g [MSA file (.a2m format)]
```
*MSA files downloadable from [here](https://github.com/OATML-Markslab/Tranception/tree/main?tab=readme-ov-file#multiple-sequence-alignments-msas)

## Reference
If you use this repository in your work, please cite the following paper:
```
Darmawan, J. T., Gal, Y., & Notin, P. (2023). Sampling protein language models for functional protein design. In NeurIPS 2023 Generative AI and Biology (GenBio) Workshop.
```

### BibTeX
```bibtex
@inproceedings{
darmawan2023sampling,
title={Sampling Protein Language Models for Functional Protein Design},
author={Jeremie Theddy Darmawan and Yarin Gal and Pascal Notin},
booktitle={NeurIPS 2023 Generative AI and Biology (GenBio) Workshop},
year={2023},
url={https://openreview.net/forum?id=JPOW9FToYX}
}
```

## Links
- NeurIPS 2023 GenBio proceedings: https://openreview.net/pdf?id=JPOW9FToYX
- NeurIPS 2023 MLSB proceedings: https://www.mlsb.io/papers_2023/Sampling_Protein_Language_Models_for_Functional_Protein_Design.pdf
